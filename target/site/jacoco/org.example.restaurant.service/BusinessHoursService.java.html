<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BusinessHoursService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">final</a> &gt; <a href="index.source.html" class="el_package">org.example.restaurant.service</a> &gt; <span class="el_source">BusinessHoursService.java</span></div><h1>BusinessHoursService.java</h1><pre class="source lang-java linenums">package org.example.restaurant.service;

import org.example.restaurant.model.BusinessHours;
import org.example.restaurant.model.Restaurant;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

/**
 * Service for handling business hours operations.
 */
<span class="fc" id="L19">public class BusinessHoursService {</span>

    // Taiwan public holidays (simplified)
<span class="fc" id="L22">    private static final Set&lt;LocalDate&gt; HOLIDAYS = new HashSet&lt;&gt;();</span>

    static {
        // 2024-2025 Taiwan holidays (example)
<span class="fc" id="L26">        HOLIDAYS.add(LocalDate.of(2024, 1, 1)); // New Year</span>
<span class="fc" id="L27">        HOLIDAYS.add(LocalDate.of(2024, 2, 8)); // Lunar New Year Eve</span>
<span class="fc" id="L28">        HOLIDAYS.add(LocalDate.of(2024, 2, 9)); // Lunar New Year</span>
<span class="fc" id="L29">        HOLIDAYS.add(LocalDate.of(2024, 2, 10));</span>
<span class="fc" id="L30">        HOLIDAYS.add(LocalDate.of(2024, 2, 11));</span>
<span class="fc" id="L31">        HOLIDAYS.add(LocalDate.of(2024, 2, 12));</span>
<span class="fc" id="L32">        HOLIDAYS.add(LocalDate.of(2024, 2, 13));</span>
<span class="fc" id="L33">        HOLIDAYS.add(LocalDate.of(2024, 2, 14)); // Valentine's also LNY</span>
<span class="fc" id="L34">        HOLIDAYS.add(LocalDate.of(2024, 4, 4)); // Children's Day</span>
<span class="fc" id="L35">        HOLIDAYS.add(LocalDate.of(2024, 4, 5)); // Tomb Sweeping Day</span>
<span class="fc" id="L36">        HOLIDAYS.add(LocalDate.of(2024, 6, 10)); // Dragon Boat Festival</span>
<span class="fc" id="L37">        HOLIDAYS.add(LocalDate.of(2024, 9, 17)); // Mid-Autumn Festival</span>
<span class="fc" id="L38">        HOLIDAYS.add(LocalDate.of(2024, 10, 10)); // National Day</span>
<span class="fc" id="L39">        HOLIDAYS.add(LocalDate.of(2025, 1, 1)); // New Year 2025</span>
<span class="fc" id="L40">        HOLIDAYS.add(LocalDate.of(2025, 1, 28)); // Lunar New Year 2025</span>
<span class="fc" id="L41">        HOLIDAYS.add(LocalDate.of(2025, 1, 29));</span>
<span class="fc" id="L42">        HOLIDAYS.add(LocalDate.of(2025, 1, 30));</span>
<span class="fc" id="L43">        HOLIDAYS.add(LocalDate.of(2025, 1, 31));</span>
<span class="fc" id="L44">        HOLIDAYS.add(LocalDate.of(2025, 2, 1));</span>
<span class="fc" id="L45">    }</span>

    /**
     * Check if a restaurant is open now.
     * v(G) = ~8
     */
    public boolean isOpenNow(Restaurant restaurant) {
<span class="fc" id="L52">        return isOpenAt(restaurant, LocalDateTime.now());</span>
    }

    /**
     * Check if a restaurant is open at a specific time.
     * v(G) = ~12
     */
    public boolean isOpenAt(Restaurant restaurant, LocalDateTime dateTime) {
<span class="fc bfc" id="L60" title="All 4 branches covered.">        if (restaurant == null || dateTime == null) {</span>
<span class="fc" id="L61">            return false;</span>
        }

<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (!restaurant.isActive()) {</span>
<span class="fc" id="L65">            return false;</span>
        }

<span class="fc" id="L68">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L70">            return false;</span>
        }

        // Check holiday closure
<span class="fc" id="L74">        LocalDate date = dateTime.toLocalDate();</span>
<span class="fc bfc" id="L75" title="All 4 branches covered.">        if (hours.isClosedOnHolidays() &amp;&amp; isHoliday(date)) {</span>
<span class="fc" id="L76">            return false;</span>
        }

        // Check regular hours
<span class="fc" id="L80">        DayOfWeek day = dateTime.getDayOfWeek();</span>
<span class="fc" id="L81">        BusinessHours.TimeSlot slot = hours.getHours(day);</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (slot == null) {</span>
<span class="fc" id="L84">            return false;</span>
        }

<span class="fc" id="L87">        LocalTime time = dateTime.toLocalTime();</span>
<span class="fc" id="L88">        return slot.contains(time);</span>
    }

    /**
     * Check if a date is a public holiday.
     * v(G) = ~4
     */
    public boolean isHoliday(LocalDate date) {
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (date == null) {</span>
<span class="fc" id="L97">            return false;</span>
        }
<span class="fc" id="L99">        return HOLIDAYS.contains(date);</span>
    }

    /**
     * Add a custom holiday.
     */
    public void addHoliday(LocalDate date) {
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (date != null) {</span>
<span class="fc" id="L107">            HOLIDAYS.add(date);</span>
        }
<span class="fc" id="L109">    }</span>

    /**
     * Remove a holiday.
     */
    public void removeHoliday(LocalDate date) {
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (date != null) {</span>
<span class="fc" id="L116">            HOLIDAYS.remove(date);</span>
        }
<span class="fc" id="L118">    }</span>

    /**
     * Find restaurants that are open at a specific time.
     * v(G) = ~6
     */
    public List&lt;Restaurant&gt; findOpenRestaurants(List&lt;Restaurant&gt; restaurants,
            LocalDateTime dateTime) {
<span class="fc bfc" id="L126" title="All 4 branches covered.">        if (restaurants == null || restaurants.isEmpty()) {</span>
<span class="fc" id="L127">            return new ArrayList&lt;&gt;();</span>
        }

<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (dateTime == null) {</span>
<span class="fc" id="L131">            dateTime = LocalDateTime.now();</span>
        }

<span class="fc" id="L134">        final LocalDateTime checkTime = dateTime;</span>

<span class="fc" id="L136">        return restaurants.stream()</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">                .filter(r -&gt; r != null)</span>
<span class="fc" id="L138">                .filter(r -&gt; isOpenAt(r, checkTime))</span>
<span class="fc" id="L139">                .collect(Collectors.toList());</span>
    }

    /**
     * Find restaurants open now.
     */
    public List&lt;Restaurant&gt; findOpenNow(List&lt;Restaurant&gt; restaurants) {
<span class="fc" id="L146">        return findOpenRestaurants(restaurants, LocalDateTime.now());</span>
    }

    /**
     * Get next open time for a restaurant.
     * v(G) = ~10
     */
    public LocalDateTime getNextOpenTime(Restaurant restaurant) {
<span class="fc" id="L154">        return getNextOpenTime(restaurant, LocalDateTime.now());</span>
    }

    public LocalDateTime getNextOpenTime(Restaurant restaurant, LocalDateTime from) {
<span class="fc bfc" id="L158" title="All 4 branches covered.">        if (restaurant == null || from == null) {</span>
<span class="fc" id="L159">            return null;</span>
        }

<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (!restaurant.isActive()) {</span>
<span class="fc" id="L163">            return null;</span>
        }

<span class="fc" id="L166">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L168">            return null;</span>
        }

        // Check if currently open
<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (isOpenAt(restaurant, from)) {</span>
<span class="fc" id="L173">            return from;</span>
        }

        // Search next 14 days
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (int i = 0; i &lt;= 14; i++) {</span>
<span class="fc" id="L178">            LocalDate date = from.toLocalDate().plusDays(i);</span>

            // Skip holidays if restaurant closes on holidays
<span class="fc bfc" id="L181" title="All 4 branches covered.">            if (hours.isClosedOnHolidays() &amp;&amp; isHoliday(date)) {</span>
<span class="fc" id="L182">                continue;</span>
            }

<span class="fc" id="L185">            DayOfWeek day = date.getDayOfWeek();</span>
<span class="fc" id="L186">            BusinessHours.TimeSlot slot = hours.getHours(day);</span>

<span class="fc bfc" id="L188" title="All 2 branches covered.">            if (slot == null) {</span>
<span class="fc" id="L189">                continue;</span>
            }

<span class="fc" id="L192">            LocalDateTime openTime = LocalDateTime.of(date, slot.getOpenTime());</span>

<span class="fc bfc" id="L194" title="All 2 branches covered.">            if (i == 0) {</span>
                // Same day - only if opening time is in the future
<span class="fc bfc" id="L196" title="All 2 branches covered.">                if (openTime.isAfter(from)) {</span>
<span class="fc" id="L197">                    return openTime;</span>
                }
            } else {
<span class="fc" id="L200">                return openTime;</span>
            }
        }

<span class="fc" id="L204">        return null; // Restaurant doesn't open in the next 14 days</span>
    }

    /**
     * Get closing time for today.
     * v(G) = ~6
     */
    public LocalTime getClosingTimeToday(Restaurant restaurant) {
<span class="fc bfc" id="L212" title="All 2 branches covered.">        if (restaurant == null) {</span>
<span class="fc" id="L213">            return null;</span>
        }

<span class="fc" id="L216">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L218">            return null;</span>
        }

<span class="fc" id="L221">        DayOfWeek today = LocalDate.now().getDayOfWeek();</span>
<span class="fc" id="L222">        BusinessHours.TimeSlot slot = hours.getHours(today);</span>

<span class="fc bfc" id="L224" title="All 2 branches covered.">        if (slot == null) {</span>
<span class="fc" id="L225">            return null;</span>
        }

<span class="fc" id="L228">        return slot.getCloseTime();</span>
    }

    /**
     * Check if restaurant is closing soon (within minutes).
     * v(G) = ~8
     */
    public boolean isClosingSoon(Restaurant restaurant, int withinMinutes) {
<span class="fc bfc" id="L236" title="All 4 branches covered.">        if (restaurant == null || withinMinutes &lt;= 0) {</span>
<span class="fc" id="L237">            return false;</span>
        }

<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (!isOpenNow(restaurant)) {</span>
<span class="fc" id="L241">            return false;</span>
        }

<span class="fc" id="L244">        LocalTime closingTime = getClosingTimeToday(restaurant);</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (closingTime == null) {</span>
<span class="nc" id="L246">            return false;</span>
        }

<span class="fc" id="L249">        LocalTime now = LocalTime.now();</span>
<span class="fc" id="L250">        LocalTime threshold = now.plusMinutes(withinMinutes);</span>

        // Handle overnight closing
<span class="pc bpc" id="L253" title="1 of 2 branches missed.">        if (closingTime.isBefore(now)) {</span>
<span class="nc" id="L254">            return false; // Closes after midnight, not soon</span>
        }

<span class="pc bpc" id="L257" title="2 of 4 branches missed.">        return closingTime.isBefore(threshold) || closingTime.equals(threshold);</span>
    }

    /**
     * Get restaurants that will close soon.
     * v(G) = ~4
     */
    public List&lt;Restaurant&gt; findClosingSoon(List&lt;Restaurant&gt; restaurants, int withinMinutes) {
<span class="fc bfc" id="L265" title="All 4 branches covered.">        if (restaurants == null || restaurants.isEmpty()) {</span>
<span class="fc" id="L266">            return new ArrayList&lt;&gt;();</span>
        }

<span class="fc" id="L269">        return restaurants.stream()</span>
<span class="fc bfc" id="L270" title="All 2 branches covered.">                .filter(r -&gt; r != null)</span>
<span class="fc" id="L271">                .filter(r -&gt; isClosingSoon(r, withinMinutes))</span>
<span class="fc" id="L272">                .collect(Collectors.toList());</span>
    }

    /**
     * Get operating days count per week.
     * v(G) = ~5
     */
    public int getOperatingDaysCount(Restaurant restaurant) {
<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (restaurant == null) {</span>
<span class="fc" id="L281">            return 0;</span>
        }

<span class="fc" id="L284">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L285" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L286">            return 0;</span>
        }

<span class="fc" id="L289">        int count = 0;</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">        for (DayOfWeek day : DayOfWeek.values()) {</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            if (hours.getHours(day) != null) {</span>
<span class="fc" id="L292">                count++;</span>
            }
        }

<span class="fc" id="L296">        return count;</span>
    }

    /**
     * Get business hours summary string.
     * v(G) = ~8
     */
    public String getBusinessHoursSummary(Restaurant restaurant) {
<span class="fc bfc" id="L304" title="All 2 branches covered.">        if (restaurant == null) {</span>
<span class="fc" id="L305">            return &quot;無資料&quot;;</span>
        }

<span class="fc" id="L308">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L310">            return &quot;無營業時間資料&quot;;</span>
        }

<span class="fc" id="L313">        int operatingDays = getOperatingDaysCount(restaurant);</span>

<span class="fc bfc" id="L315" title="All 2 branches covered.">        if (operatingDays == 0) {</span>
<span class="fc" id="L316">            return &quot;目前休業中&quot;;</span>
<span class="fc bfc" id="L317" title="All 2 branches covered.">        } else if (operatingDays == 7) {</span>
<span class="fc" id="L318">            return &quot;每日營業&quot;;</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        } else if (operatingDays &gt;= 5) {</span>
<span class="fc" id="L320">            return &quot;週一至週五營業&quot;;</span>
        } else {
<span class="fc" id="L322">            return &quot;部分時段營業&quot;;</span>
        }
    }

    /**
     * Check if restaurant is open 24 hours on a day.
     * v(G) = ~5
     */
    public boolean is24Hours(Restaurant restaurant, DayOfWeek day) {
<span class="fc bfc" id="L331" title="All 4 branches covered.">        if (restaurant == null || day == null) {</span>
<span class="fc" id="L332">            return false;</span>
        }

<span class="fc" id="L335">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L337">            return false;</span>
        }

<span class="fc" id="L340">        BusinessHours.TimeSlot slot = hours.getHours(day);</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">        if (slot == null) {</span>
<span class="fc" id="L342">            return false;</span>
        }

<span class="fc bfc" id="L345" title="All 2 branches covered.">        return slot.getOpenTime().equals(LocalTime.MIDNIGHT)</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">                &amp;&amp; slot.getCloseTime().equals(LocalTime.of(23, 59));</span>
    }

    /**
     * Calculate total operating hours per week.
     * v(G) = ~8
     */
    public double calculateWeeklyOperatingHours(Restaurant restaurant) {
<span class="fc bfc" id="L354" title="All 2 branches covered.">        if (restaurant == null) {</span>
<span class="fc" id="L355">            return 0.0;</span>
        }

<span class="fc" id="L358">        BusinessHours hours = restaurant.getBusinessHours();</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">        if (hours == null) {</span>
<span class="fc" id="L360">            return 0.0;</span>
        }

<span class="fc" id="L363">        double totalHours = 0.0;</span>

<span class="fc bfc" id="L365" title="All 2 branches covered.">        for (DayOfWeek day : DayOfWeek.values()) {</span>
<span class="fc" id="L366">            BusinessHours.TimeSlot slot = hours.getHours(day);</span>
<span class="pc bpc" id="L367" title="2 of 6 branches missed.">            if (slot != null &amp;&amp; slot.getOpenTime() != null &amp;&amp; slot.getCloseTime() != null) {</span>
<span class="fc" id="L368">                LocalTime open = slot.getOpenTime();</span>
<span class="fc" id="L369">                LocalTime close = slot.getCloseTime();</span>

                // Calculate hours
                double hoursOpen;
<span class="fc bfc" id="L373" title="All 2 branches covered.">                if (close.isBefore(open)) {</span>
                    // Overnight - e.g., 22:00 to 02:00
<span class="fc" id="L375">                    hoursOpen = (24 - open.getHour()) + close.getHour();</span>
                } else {
<span class="fc" id="L377">                    hoursOpen = close.getHour() - open.getHour();</span>
<span class="fc" id="L378">                    hoursOpen += (close.getMinute() - open.getMinute()) / 60.0;</span>
                }

<span class="fc" id="L381">                totalHours += hoursOpen;</span>
            }
        }

<span class="fc" id="L385">        return Math.round(totalHours * 10.0) / 10.0;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>